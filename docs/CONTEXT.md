# Контекст проекта

Проект представляет собой Telegram-бот для эскалационного клиентского чата (POS / терминалы).

Важно:
- это НЕ Service Desk
- это НЕ система обработки заявок
- бот не вмешивается в диалог и не отвечает в группах

## Назначение бота

Бот предназначен для:
- бесшумного сбора всей переписки в эскалационных чатах
- сохранения полного raw-контекста сообщений
- последующего анализа проблем, реакций и повторяемости инцидентов

## Текущая архитектура (v1)

### Ingestion
- бот получает все сообщения чата
- сохраняет их в таблицу `messages` в максимально сыром виде
- сохраняются:
  - текст
  - reply / forward
  - metadata Telegram
  - service events
  - raw JSON

### Классификация сообщений (v1)
- при поступлении нового сообщения бот:
  - создаёт строку в `message_classification` со статусом `UNCLASSIFIED`
  - пытается классифицировать сообщение по rules.yaml (rule-based, без ИИ)
- если правило срабатывает:
  - сообщение получает тип проблемы
- если правило не срабатывает:
  - сообщение остаётся `UNCLASSIFIED`

### Принципы классификации
- классификация best-effort
- отсутствие классификации считается допустимым результатом
- ложные срабатывания хуже, чем отсутствие классификации
- переобработка возможна на следующих этапах (offline)

## Ограничения v1
- бот не определяет конфигурационные единицы (АЗС, терминал, рабочее место)
- бот не анализирует Service Desk заявки
- бот не отвечает на сообщения и не управляет диалогом

---

## Текущая архитектура (v1.1)

### Определение конфигурационных единиц (КЕ)

В рамках этапа v1.1 бот научился **определять конфигурационные единицы (КЕ)**,
упоминаемые в сообщениях эскалационных чатов.

Поддерживаемые КЕ:
- номер АЗС (`azs`)
- номер рабочего места (`workplace`)
- идентификатор терминала банка (`tid`)
- IP-адрес терминала (`ip`)
- номер заявки Service Desk (`sd_ticket`)
- дата-время заявки (`sd_dt`)

Определение КЕ выполняется **best-effort**, без ИИ, на основе rule-based правил.

### Принципы определения КЕ

- КЕ извлекаются из текста сообщений с помощью регулярных выражений
- допускается отсутствие КЕ (это валидный результат)
- ложные срабатывания хуже, чем отсутствие результата
- данные нормализуются:
  - АЗС → только цифры (2–4)
  - РМ → только цифры (1–2)
  - TID → строго 8 цифр

### Enrichment (обогащение)

После извлечения `azs` и `workplace` выполняется enrichment:
- lookup в справочнике терминалов
- добавление `tid` и `ip` как отдельных сущностей
- enrichment выполняется **только при однозначном сопоставлении**

### Reply / Visibility Layer (опционально)

Добавлен управляемый через конфигурацию слой reply:
- бот может публиковать дополнительную техническую информацию
- reply **не является управлением инцидентом**
- reply используется исключительно для повышения прозрачности и скорости реакции

Reply включается/выключается через `config.yaml`.

