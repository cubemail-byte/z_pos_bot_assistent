# tg-agent — КОНТЕКСТ ПРОЕКТА

## Что это за проект
Telegram-бот для работы в **эскалационном групповом чате** с клиентом
(POS / терминалы / АЗС).

Чат используется **не для заведения и обработки заявок** —
для этого существуют Service Desk системы.
Этот чат — слой **эскалаций и реакции на отклонения от SLA**:
- клиент недоволен временем реакции,
- массовые инциденты,
- нетипичные ситуации,
- отсутствие ответа/доступа/движения по заявке.

Задача бота — **тихо и надёжно собирать все сообщения чата**
в базу данных для последующего анализа.

Бот **не участвует в диалоге** и не мешает чату.

---

## Текущее состояние (актуально)
- Бот запущен на VPS (Ubuntu 24.04) под systemd (`tg-agent.service`)
- Используется `aiogram 3.x`
- Деплой: `git pull + restart` (`tg-agent-deploy`)
- Конфигурация:
  - `.env` — только на VPS (секреты)
  - `config.yaml` — в репозитории
  - `rules.yaml` — правила классификации (пока заготовка)
- Хранилище:
  - SQLite
  - Файл БД: `/opt/tg-agent/data/agent.db`

---

## Что бот делает сейчас (ФАКТИЧЕСКИ)
- Получает **все сообщения** из чатов, где он присутствует:
  - текст
  - фото/видео/документы (без сохранения медиа)
  - подписи (caption)
  - reply
  - forward (через `forward_origin`)
  - service-события
- Сохраняет **raw-данные** в таблицу `messages`:
  - chat_id / chat_alias / chat_type
  - from_id / username / from_display
  - text
  - reply_to_* (tg_message_id, from_id, username)
  - forward_from_*
  - content_type / has_media / service_action
  - raw_json
- Поддерживает несколько чатов (разделение по `chat_id` / `chat_alias`)
- Работает в **тихом режиме** в группах

---

## Что бот ПРИНЦИПИАЛЬНО не делает
- Не пишет в группах
- Не заменяет Service Desk
- Не пытается автоматически «чинить» или отвечать клиенту
- Не использует LLM / ИИ
- Не анализирует SLA в онлайне

---

## Архитектурная логика (ключевая)
1. **Raw ingestion — источник истины**
2. Отдельный слой классификации (`message_classification`)
3. Состояние `UNCLASSIFIED` — норма
4. Качество данных растёт со временем через правила

---

## Ближайшие шаги
1. Закончить слой классификации сообщений
2. Подключить `rules.yaml` (include / exclude)
3. Ночной reclassify UNCLASSIFIED
4. Ввести понятие эскалационного кейса
5. Аналитика реакции и повторов
