ruleset_version: "2"
description: "Rules for classifying escalation chat messages (keyword/regex, no AI)."

problem_taxonomy:
  other_code: OTHER
  multi_label: true

  codes:
    # интеграция POS ↔ касса
    NO_LINK_TO_ECR: "Проблема связи/сопряжения POS ↔ касса (ECR)"

    # связь POS ↔ банк/хост/сервер
    NO_LINK_TO_BANK: "Нет связи POS ↔ банк/хост/сервер"

    # терминал реально не работает (питание/завис/не реагирует)
    TERMINAL_DOWN: "Терминал не работает/завис/нет реакции"

    # итоги смены / сверка
    TOTAL_MISMATCH: "Расхождение итогов/сверка/итоги не бьются (после смены)"

    # расхождения/аномалии в рамках операционного дня
    INTRADAY_DUPLICATE: "Задвоение/двойное списание/двойной возврат (в рамках дня)"

    # несанкционированные возвраты/отмены
    UNSANCTIONED_REFUND: "Несанкционированные возвраты/отмены (без оператора)"

    # лояльность (ДЛС/КЧ/Татнефть/бонусы/возврат по ДЛС)
    LOYALTY_ISSUE: "Лояльность/бонусы/ДЛС/КЧ/Татнефть"

    # выдача наличных на кассе (cash-out / ПВСН)
    CASHOUT_ISSUE: "Кэш-аут/выдача наличных (ПВСН)"

    # перезагрузки
    REBOOT_LOOP: "Циклические перезагрузки/рестарты"

    # доступ/права/видимость заявок
    ACCESS_ISSUE: "Доступ/права/видимость заявки"

problem_rules:
  # ----------------------------
  # LOYALTY
  # ----------------------------
  - id: LOYALTY_ISSUE
    enabled: true
    code: LOYALTY_ISSUE
    priority: 200
    weight: 0.75
    include_any:
      - "(?i)\\bдлс\\b"
      - "(?i)\\bкч\\b"
      - "(?i)клуб\\s+чемпионов"
      - "(?i)татнефть"
      - "(?i)лояльност"
      - "(?i)бонус(ы|ов|ами)?"
      - "(?i)не\\s+начисля(ет|ются)"
      - "(?i)не\\s+списыва(ет|ются)"
      - "(?i)нет\\s+возврат(а|ов)\\s+по\\s+длс"
      - "(?i)возврат\\s+по\\s+длс"
    exclude_any:
      # чтобы не цеплять "ответы/комментарии" при обсуждении статуса
      - "(?i)по\\s+заявк(е|ам)\\b.*(закрыт|закрыта|в\\s+работе)"
    hint_symptom: "лояльность/бонусы/ДЛС/КЧ"

  # ----------------------------
  # CASHOUT / ПВСН
  # ----------------------------
  - id: CASHOUT_ISSUE
    enabled: true
    code: CASHOUT_ISSUE
    priority: 180
    weight: 0.70
    include_any:
      - "(?i)выдач[ауы]\\s+наличн"
      - "(?i)снять\\s+наличн"
      - "(?i)наличн(ые|ые\\s+на\\s+кассе)"
      - "(?i)cash\\s*out"
      - "(?i)кэш\\s*-?\\s*аут"
      - "(?i)\\bпвсн\\b"
    exclude_any: []
    hint_symptom: "кэш-аут/выдача наличных"

  # ----------------------------
  # NO LINK TO BANK/HOST
  # ----------------------------
  - id: NO_LINK_TO_BANK
    enabled: true
    code: NO_LINK_TO_BANK
    priority: 160
    weight: 0.72
    include_any:
      - "(?i)нет\\s+(связи|соединения)\\s+(с\\s+банком|с\\s+хостом|с\\s+сервером)"
      - "(?i)нет\\s+соединения\\s+с\\s+сервером"
      - "(?i)ошибка\\s+связи\\s+с\\s+банком"
      - "(?i)связь\\s+с\\s+банком"
      - "(?i)завис(ает|)\\s+на\\s+шаге\\s+\"?связь\\s+с\\s+банком\"?"
    exclude_any:
      - "(?i)нет\\s+связи\\s+с\\s+касс"
      - "(?i)касса\\s+не\\s+видит"
      - "(?i)нет\\s+ответа\\s+от\\s+терминал"  # это в ECR-интеграцию
    hint_symptom: "нет связи с банком/хостом"

  # ----------------------------
  # NO LINK TO ECR (POS <-> касса)
  # ----------------------------
  - id: NO_LINK_TO_ECR
    enabled: true
    code: NO_LINK_TO_ECR
    priority: 150
    weight: 0.70
    include_any:
      - "(?i)нет\\s+связи\\s+с\\s+касс(ой|ой\\b)"
      - "(?i)касса\\s+не\\s+видит\\s+терминал"
      - "(?i)нет\\s+ответа\\s+от\\s+терминал(а|\\b)"
      - "(?i)ошибка\\s+(интеграц|сопряж|подключени)"
      - "(?i)ошибка\\s+подключени"
      - "(?i)\\becr\\b"
    exclude_any:
      - "(?i)\\bдлс\\b"     # чтобы "нет возврата по ДЛС" не улетало сюда
      - "(?i)лояльност"
      - "(?i)бонус"
    hint_symptom: "POS ↔ касса (ECR) / нет ответа"

  # ----------------------------
  # TERMINAL DOWN (физически/логически не работает)
  # ----------------------------
  - id: TERMINAL_DOWN
    enabled: true
    code: TERMINAL_DOWN
    priority: 140
    weight: 0.68
    include_any:
      - "(?i)терминал\\s+не\\s+работа(ет|ют)"
      - "(?i)не\\s+работа(ет|ют)\\s+терминал"
      - "(?i)не\\s+работа(ет|ют)\\s+оба\\s+терминал"
      - "(?i)терминал\\s+завис"
      - "(?i)не\\s+реагиру(ет|ют)"
      - "(?i)погас\\s+экран"
      - "(?i)не\\s+включа(етс?я|ется)"
    exclude_any:
      - "(?i)нет\\s+ответа\\s+от\\s+терминал"  # уводим в NO_LINK_TO_ECR
      - "(?i)нет\\s+связи\\s+с\\s+касс"       # уводим в NO_LINK_TO_ECR
      - "(?i)связь\\s+с\\s+банком"           # уводим в NO_LINK_TO_BANK
      - "(?i)\\bдлс\\b|лояльност|бонус|\\bкч\\b"
    hint_symptom: "терминал не работает/завис"

  # ----------------------------
  # TOTAL MISMATCH (после закрытия смены)
  # ----------------------------
  - id: TOTAL_MISMATCH
    enabled: true
    code: TOTAL_MISMATCH
    priority: 120
    weight: 0.70
    include_any:
      - "(?i)не\\s+сходятс?я\\s+итог"
      - "(?i)расхождени[ея]\\s+итог"
      - "(?i)сверк[аи]\\s+итог"
      - "(?i)после\\s+закрыти(я|я\\b)\\s+смен"
      - "(?i)смена\\s+закрыта"
    exclude_any: []
    hint_symptom: "итоги/сверка/смена"

  # ----------------------------
  # INTRADAY DUPLICATE / WRONG AMOUNT
  # ----------------------------
  - id: INTRADAY_DUPLICATE
    enabled: true
    code: INTRADAY_DUPLICATE
    priority: 110
    weight: 0.70
    include_any:
      - "(?i)задво(ил|илась|ивается|ение)"
      - "(?i)двойн(ое|ая)\\s+(списани|оплат|возврат)"
      - "(?i)списал(о|и)\\s+дважды"
      - "(?i)сумма\\s+задваива(етс?я|ется)"
      - "(?i)некорректн(ая|ый)\\s+сумм"
    exclude_any:
      - "(?i)после\\s+закрыти(я|я\\b)\\s+смен"  # это больше про TOTAL_MISMATCH
    hint_symptom: "задвоение/двойное списание/возврат"

  # ----------------------------
  # UNSANCTIONED REFUND / VOID
  # ----------------------------
  - id: UNSANCTIONED_REFUND
    enabled: true
    code: UNSANCTIONED_REFUND
    priority: 115
    weight: 0.72
    include_any:
      - "(?i)несанкционированн(ый|ая|ые)\\s+(возврат|отмена)"
      - "(?i)необоснованн(о|ые)\\s+возврат"
      - "(?i)сам\\s+сделал\\s+возврат"
      - "(?i)без\\s+оператор(а|а\\b).*возврат"
      - "(?i)отмена\\s+операц"
    exclude_any: []
    hint_symptom: "несанкционированный возврат/отмена"

  # ----------------------------
  # REBOOT LOOP
  # ----------------------------
  - id: REBOOT_LOOP
    enabled: true
    code: REBOOT_LOOP
    priority: 90
    weight: 0.65
    include_any:
      - "(?i)перезагрузк"
      - "(?i)перезагружа(етс?я|ется)"
      - "(?i)рестарт"
      - "(?i)reboot"
    exclude_any: []
    hint_symptom: "перезагрузки/рестарты"

  # ----------------------------
  # ACCESS ISSUE (нет доступа / не видим заявки)
  # ----------------------------
  - id: ACCESS_ISSUE
    enabled: true
    code: ACCESS_ISSUE
    priority: 85
    weight: 0.60
    include_any:
      - "(?i)не\\s+видим\\s+заявк"
      - "(?i)не\\s+вижу\\s+заявк"
      - "(?i)не\\s+отображается\\s+заявк"
      - "(?i)нет\\s+доступа"
      - "(?i)нет\\s+прав"
      - "(?i)нет\\s+прав\\s+на\\s+заявк"
      - "(?i)доступ\\s+к\\s+заявк(е|ам)\\s+отсутствует"
      - "(?i)заявк(а|и)\\s+не\\s+открыва(етс?я|ется)"
      - "(?i)не\\s+могу\\s+открыть\\s+заявк"
    exclude_any: []
    hint_symptom: "доступ/права/видимость заявки"
